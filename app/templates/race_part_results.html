{% extends "base.html" %}
{% block content %}
<h1>{{ race.race_id }} â€“ {{ race_part.race_part_id }}</h1>
<div class="card">
  <form method="get" action="/race/{{ race.race_id }}/part/{{ race_part.race_part_id }}">
    <label>
      Group filter (multi-select)
      <select name="group" multiple size="4">
        {% for group in groups %}
          <option value="{{ group }}" {% if group in group_filters %}selected{% endif %}>{{ group }}</option>
        {% endfor %}
      </select>
    </label>
    <label>
      Sex filter (multi-select)
      <select name="sex" multiple size="3">
        {% for sex in sexes %}
          <option value="{{ sex }}" {% if sex in sex_filters %}selected{% endif %}>{{ sex }}</option>
        {% endfor %}
      </select>
    </label>
    <div class="actions">
      <button class="ghost" type="submit">Apply Filters</button>
      <a class="button ghost" href="/race/{{ race.race_id }}/part/{{ race_part.race_part_id }}">Clear Filters</a>
    </div>
  </form>
</div>
<div class="card">
  <div class="actions">
    {% if user and (user.role == "admin" or race.race_id in user.race_ids) and not race_part.is_overall %}
      <a class="button" href="/race/{{ race.race_id }}/part/{{ race_part.race_part_id }}/manage/timing-events">Manage Timing Events</a>
      <a class="button" href="/race/{{ race.race_id }}/part/{{ race_part.race_part_id }}/submit-start">Submit Start Times</a>
      <a class="button" href="/race/{{ race.race_id }}/part/{{ race_part.race_part_id }}/submit-end">Submit End Times</a>
      <a class="button" href="/race/{{ race.race_id }}/part/{{ race_part.race_part_id }}/submit-duration">Submit Durations</a>
      <a class="button" href="/race/{{ race.race_id }}/part/{{ race_part.race_part_id }}/timer">Show Timer</a>
    {% endif %}
  </div>
</div>
<div class="card">
  {% set extra_cols = (parts | rejectattr('is_overall') | list | length) if race_part.is_overall else 0 %}
  {% set colspan_count = 5 + extra_cols %}
  <div class="table-wrap">
    <table class="table">
    <thead>
      <tr>
        <th>#</th>
        <th>Bib</th>
        <th>Name</th>
        <th>Group</th>
        {% if race_part.is_overall %}
          {% for part in parts if not part.is_overall %}
            <th>{{ part.race_part_id }}</th>
          {% endfor %}
          <th>Overall</th>
        {% else %}
          <th>Time</th>
        {% endif %}
      </tr>
    </thead>
    <tbody id="results-body">
      {% for row in rows %}
      <tr>
        <td>{{ row.position }}</td>
        <td>{{ row.bib }}</td>
        <td>{{ row.name }}</td>
        <td>{{ row.group }}</td>
        {% if race_part.is_overall %}
          {% for part in parts if not part.is_overall %}
            <td>{{ row.parts[part.race_part_id] }}</td>
          {% endfor %}
          <td>{{ row.duration }}</td>
        {% else %}
          <td>{{ row.duration }}</td>
        {% endif %}
      </tr>
      {% else %}
      <tr>
        <td colspan="{{ colspan_count }}" class="small">No results yet.</td>
      </tr>
      {% endfor %}
    </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const resultsBody = document.getElementById('results-body');
  const isOverall = {{ 'true' if race_part.is_overall else 'false' }};
  const partIds = {{ parts | rejectattr('is_overall') | map(attribute='race_part_id') | list | tojson }};
  const columnCount = isOverall ? 5 + partIds.length : 5;

  function buildRow(row) {
    const cells = [
      `<td>${row.position || ''}</td>`,
      `<td>${row.bib}</td>`,
      `<td>${row.name}</td>`,
      `<td>${row.group}</td>`,
    ];
    if (isOverall) {
      partIds.forEach((partId) => {
        const value = row.parts && row.parts[partId] ? row.parts[partId] : '';
        cells.push(`<td>${value}</td>`);
      });
      cells.push(`<td>${row.duration}</td>`);
    } else {
      cells.push(`<td>${row.duration}</td>`);
    }
    return `<tr>${cells.join('')}</tr>`;
  }

  async function refreshResults() {
    const url = new URL(window.location.href);
    url.searchParams.set('format', 'json');
    try {
      const response = await fetch(url.toString(), {
        headers: { 'X-Requested-With': 'fetch' },
      });
      if (!response.ok) {
        return;
      }
      const data = await response.json();
      const rows = data.rows || [];
      if (!rows.length) {
        resultsBody.innerHTML = `<tr><td colspan="${columnCount}" class="small">No results yet.</td></tr>`;
        return;
      }
      resultsBody.innerHTML = rows.map(buildRow).join('');
    } catch (error) {
      // Keep current table if refresh fails.
    }
  }

  refreshResults();
  setInterval(refreshResults, 5000);
</script>
{% endblock %}
