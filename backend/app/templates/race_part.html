{% extends "base.html" %}
{% block content %}
<div class="d-flex align-items-start justify-content-between gap-3 flex-wrap mb-3">
  <div>
    <div class="text-muted"><a href="/races/{{ race.race_id }}">← Back</a></div>
    <h1 class="h3 m-0">{{ part.name }}</h1>
    <div class="text-muted">Race: {{ race.race_id }} • Part ID: {{ part.race_part_id }} • Type: {{ part.time_event_type }}</div>
  </div>
  {% if staff %}
    <div class="d-flex gap-2 flex-wrap">
      <a class="btn btn-outline-secondary" href="/api/results.csv?race_id={{ race.race_id }}&race_part_id={{ part.race_part_id }}">Download results CSV</a>
      {% if part.time_event_type != "overall" %}
        <a class="btn btn-primary" href="/admin/races/{{ race.race_id }}/parts/{{ part.race_part_id }}/timing/new">Submit timing event</a>
      {% endif %}
{% if part.time_event_type == "end_time" %}
        <a class="btn btn-outline-secondary" href="/admin/races/{{ race.race_id }}/parts/{{ part.race_part_id }}/start-times">Set start times</a>
      {% endif %}
    </div>
  {% endif %}
</div>

{% if part.time_event_type == "end_time" %}
  <div class="alert alert-info">
    <div class="fw-semibold">End-time mode</div>
    <div class="small">Durations are computed as <code>end_time - start_time</code>. Set a <code>DEFAULT</code> start time (or per-group start times) to get results.</div>
    {% if start_times %}
      <div class="small mt-2">
        <span class="fw-semibold">Configured start times:</span>
        {% for st in start_times %}
          <span class="badge text-bg-light border">{{ st.group_name }} = {{ st.start_time_hms }}</span>
        {% endfor %}
      </div>
    {% endif %}
  </div>
{% endif %}

<div class="d-flex gap-2 mb-3 flex-wrap">
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <div class="row g-2 align-items-end">
      <div class="col-12 col-md-4">
        <label class="form-label small">Filter by sex</label>
        <select class="form-select form-select-sm" id="filter-sex">
          <option value="">All</option>
          {% for v in (results | map(attribute='sex') | list) | unique %}
            {% if v %}
              <option value="{{ v|lower }}">{{ v }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label small">Filter by group</label>
        <select class="form-select form-select-sm" id="filter-group">
          <option value="">All</option>
          {% for v in (results | map(attribute='group') | list) | unique %}
            {% if v %}
              <option value="{{ v|lower }}">{{ v }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-4">
        <button class="btn btn-outline-secondary btn-sm" id="clear-filters" type="button">Clear filters</button>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div class="fw-semibold">Results</div>
      <div class="small text-muted">Auto-refresh every {{ (poll_ms/1000)|int }}s</div>
    </div>
    <div class="table-responsive">
      <table id="results-table" class="table table-sm align-middle" id="results-table">
        {% include "partials/results_table.html" %}
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const pollMs = {{ poll_ms }};
  const url = "/api/races/{{ race.race_id }}/parts/{{ part.race_part_id }}/results/partial";

  function applyFilters() {
    const sex = (document.getElementById('filter-sex')?.value || '').toLowerCase();
    const grp = (document.getElementById('filter-group')?.value || '').toLowerCase();
    document.querySelectorAll('#results-table tbody tr').forEach(tr => {
      const s = (tr.getAttribute('data-sex') || '');
      const g = (tr.getAttribute('data-group') || '');
      const okSex = !sex || s === sex;
      const okGrp = !grp || g === grp;
      tr.style.display = (okSex && okGrp) ? '' : 'none';
    });
  }

  document.getElementById('filter-sex')?.addEventListener('change', applyFilters);
  document.getElementById('filter-group')?.addEventListener('change', applyFilters);
  document.getElementById('clear-filters')?.addEventListener('click', () => {
    document.getElementById('filter-sex').value = '';
    document.getElementById('filter-group').value = '';
    applyFilters();
  });

  applyFilters();

  setInterval(async () => {
    try {
      const res = await fetch(url, {cache: "no-store"});
      const html = await res.text();
      document.querySelector("#results-table").innerHTML = html;
      applyFilters();
    } catch (e) {
      console.warn("poll failed", e);
    }
  }, pollMs);
</script>
{% endblock %}
